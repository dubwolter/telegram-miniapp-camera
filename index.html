<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiniApp Barcode Scanner</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  #scanner-container { width: 100%; max-width: 500px; margin: auto; }
  video, canvas { width: 100%; }
  ul { max-height: 200px; overflow-y: auto; }
</style>
</head>
<body class="p-3">
<div class="container text-center">
  <h3>Barcode Scanner MiniApp</h3>
  <div id="scanner-container"><div id="scanner"></div></div>
  <button id="start-btn" class="btn btn-primary mt-3">Start Scanning</button>
  <h5 class="mt-4">Scanned Codes:</h5>
  <ul id="codes-list" class="list-group"></ul>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js?59"></script>

<script>
const codesList = document.getElementById('codes-list');
const startBtn = document.getElementById('start-btn');
const savedCodes = JSON.parse(localStorage.getItem('scannedCodes') || '[]');
const cameraAllowed = localStorage.getItem('cameraAllowed') === 'true';

function renderCodes() {
    codesList.innerHTML = '';
    savedCodes.forEach(code => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = code;
        codesList.appendChild(li);
    });
}

function addCode(code) {
    if (!savedCodes.includes(code)) {
        savedCodes.push(code);
        localStorage.setItem('scannedCodes', JSON.stringify(savedCodes));
        renderCodes();
    }
}

async function startScanner() {
  try {
    const stream = await Telegram.WebApp.getUserMedia({ video: { facingMode: "environment" } });
    document.querySelector('#scanner').innerHTML = '';
    const video = document.createElement('video');
    video.srcObject = stream;
    video.autoplay = true;
    document.querySelector('#scanner').appendChild(video);

    // Передать видео в QuaggaJS
    Quagga.init({
      inputStream : {
        name : "Live",
        type : "LiveStream",
        target: video,
      },
      decoder : { readers : ["code_128_reader","ean_reader","upc_reader"] }
    }, function(err) {
        if (!err) Quagga.start();
    });

    Quagga.onDetected(data => {
        Quagga.pause();
        const code = data.codeResult.code;
        if (!savedCodes.includes(code) && confirm("Сохранить код: " + code + "?")) {
            addCode(code);
        }
        Quagga.start();
    });

  } catch (err) {
    alert("Не удалось получить доступ к камере: " + err.message);
  }
}


// Если камера уже разрешена, запускаем сразу
if (cameraAllowed) {
    startBtn.style.display = 'none';
    startScanner();
} else {
    startBtn.addEventListener('click', () => {
        startBtn.disabled = true;
        startScanner();
    });
}

// Отобразить уже сохранённые штрихкоды при загрузке
renderCodes();
</script>
</body>
</html>
