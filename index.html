<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Montserrat", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        #reader {
            width: 100%;
            max-width: 500px;
            margin: auto;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding-top: 20px;
        }

        table {
            max-width: 500px;
            width: 100%;
            margin-top: 15px;
            table-layout: fixed; /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ */
            word-wrap: break-word; /* –ø–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
        }

            table td, table th {
                overflow: hidden;
                text-overflow: ellipsis; /* –¥–æ–±–∞–≤–ª—è–µ—Ç ... –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ */
                white-space: nowrap; /* —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –±—ã–ª –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ, —É–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å */
            }

        /* –î–æ–±–∞–≤–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
    </style>
    <title>Barcode/QR Scanner</title>
</head>
<body>
    <div class="container">
        <h3>üì∑ Scan QR / Barcode</h3>
        <div id="reader"></div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover shadow-sm" id="codesTable">
                <thead class="table-primary">
                    <tr>
                        <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                        <th>–¢–∏–ø –∫–æ–¥–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <button class="btn btn-danger mt-2" id="clearAllBtn"><i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        const tableBody = document.querySelector("#codesTable tbody");
        const clearAllBtn = document.getElementById("clearAllBtn");

        let scannedCodes = JSON.parse(localStorage.getItem("scannedCodes") || "[]");

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function renderTable() {
            tableBody.innerHTML = "";
            scannedCodes.forEach((item, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${item.value}</td>
          <td>${item.type}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" data-index="${index}"><i class="bi bi-trash"></i></button>
          </td>`;
                tableBody.appendChild(tr);
            });
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
            document.querySelectorAll("#codesTable button").forEach(btn => {
                btn.addEventListener("click", () => {
                    const idx = btn.getAttribute("data-index");
                    scannedCodes.splice(idx, 1);
                    localStorage.setItem("scannedCodes", JSON.stringify(scannedCodes));
                    renderTable();
                });
            });
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã
        clearAllBtn.addEventListener("click", () => {
            if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É?")) {
                scannedCodes = [];
                localStorage.removeItem("scannedCodes");
                renderTable();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è html5-qrcode
        window.addEventListener("load", () => {
            const html5QrcodeScanner = new Html5Qrcode("reader");
            let scanning = true;

            html5QrcodeScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    experimentalFeatures: { useBarCodeDetectorIfSupported: true }
                },
                (decodedText, decodedResult) => {
                    if (scanning) {
                        scanning = false; // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ –∑–∞ —Ä–∞–∑
                        const codeData = { value: decodedText, type: decodedResult.result.format.formatName || "unknown" };
                        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –∫–æ–¥
                        if (!scannedCodes.some(c => c.value === codeData.value)) {
                            scannedCodes.push(codeData);
                            localStorage.setItem("scannedCodes", JSON.stringify(scannedCodes));
                            renderTable();
                        }
                        // —Ä–∞–∑—Ä–µ—à–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å–∫–∞–Ω —á–µ—Ä–µ–∑ 1 —Å–µ–∫
                        setTimeout(() => { scanning = true; }, 1000);
                    }
                },
                (errorMessage) => { /* –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–ª–∫–∏–µ –æ—à–∏–±–∫–∏ */ }
            ).catch(err => alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: " + err));

            renderTable();
        });
    </script>
</body>
</html>
